<html>
    <head>
        {% load static %}
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <script src="{% static 'tmv_app/js/d3.v3.min.js' %}"></script>
        <script language="JavaScript" src="https://code.jquery.com/jquery-1.4.4.js"></script>
        <title>Scoping</title>
        {% if query.type == "default" %}
          <link href="{% static 'scoping/css/styling.css' %}" rel="stylesheet" type="text/css">
        {% else %}
          <link href="{% static 'scoping/css/stylingsbs.css' %}" rel="stylesheet" type="text/css">
        {% endif %}
    </head>
    <body>

        {% include 'scoping/nav_bar.html' with user=user qid=query.id %}
        <div id="main">
            <div id="graph">
                {% if request.session.appmode == 'scoping' %}
                  <h1> Scoping Review Helper</h1>
                {% else %}
                  <h1> Snowballing - Query Helper</h1>
                {% endif %}
                <br/>

                <!-- Query manager -->
                {% if request.session.appmode == 'scoping' %}
                  <h2> Query Progress </h2>
                {% else %}
                    {% if substep == "1" %}
                      <h2> Query Progress - SB substep {{ substep }} (Identifying references and scraping citations)</h2>
                    {% else %}
                      <h2> Query Progress - SB substep {{ substep }} (Obtaining information for all identified references)</h2>
                    {% endif %}
                {% endif %}

                {% if log %}
                    {% if request.session.appmode == 'scoping' %}
                      <br/>
                        (Refresh page to update progress)
                      <br/><br/>

                      <div id="logbox">
                        {% for l in log %}
                            {{l}}<br>
                        {% endfor %}
                      </div>
                    {% else %}
                      <br/>
                        (Refresh page to update progress)
                      <br/><br/>
                      <table>
                        <tr class="logbox">
                          <td style="width: 50%; border: 1px solid white;">
                            Backward query
                            <div id="logbox_sb">
                              {% if log_b %}
                                {% for l in log_b %}
                                  {{l}}<br>
                                {% endfor %}
                              {% endif %}
                            </div>
                          </td>
                          <td style="width: 50%; border: 1px solid white;">
                            Forward query
                            <div id="logbox_sb">
                              {% if log_f %}
                                {% for l in log_f %}
                                  {{l}}<br>
                                {% endfor %}
                              {% endif %}
                            </div>
                          </td>
                        </tr>
                      </table>
                    {% endif %}
                {% endif %}

                <br/>
                {% if finished %}
<!-- Scoping review -->
                    {% if request.session.appmode == 'scoping' %}
                        <p>Looks like it's done!</p>
                        {% if doclength == 0 %}
                            <p id="doc_adder1">{{doclength}} of these documents are in the database. Would you like to add them now?
                            <br/>
                            <a href="/scoping/dodocadd?qid={{query_b.id}}&db={{query_b.database}}"><button>Add Documents</button></a>
                        {% else %}
                            <p><a href="../../../docs/{{query_b.id}}">View the documents</a>
                        {% endif %}
                    {% else %}
<!-- Snowballing session -->
                        <p></p>
                            {% include 'scoping/docrel_table.html' with summary_stats=summary_stats %}
                        <p>
                        {% if substep == "1" %}
                            <p>Looks like it's done! (Another query might be needed in case references are not yet in the database)</p>
                            <p>You will now be automatically redirected to the next substep in a few seconds. You may also click the button below to accelerate the process.</p>
                            <br/>
                            <a href="/scoping/dodocrefadd?qid={{query_b.id}}&q2id={{query_f.id}}&db={{query_b.database}}"><button>Add citations and scrape References</button></a>
                        {% else %}
                            {% if docadded == 0 %} 
                              {% if query_b.dlstat != "NOREC" %}
                                <p id="doc_adder1">References have been found in {{query_b.database}}. We will add them to the database and check for those that were not.</p>
                                <br/>
                                <a href="/scoping/dodocadd?qid={{query_b.id}}&q2id={{query_f.id}}&db={{query_b.database}}"><button>Add missing reference information and further checks</button></a>
                              {% else %}
                                {% if query_b.database == "WoS" %}
                                  <p id="doc_adder1">None of the references were in {{query_b.database}}.
                                  <br/>
                                  <a href="../../../../sbs_allocateDocsToUser/{{query_b.id}}/{{query_f.id}}">View the references and citations</a>
                                  <a href="../../../../sbs_allocateDocsToUser/{{query_b.id}}/{{query_f.id}}">Allocate references and citations to several users</a>
                                {% else %}
                                  <p id="doc_adder1">None of the references were in {{query_b.database}}.
                                  <br/>
                                  <a href="/scoping/dodocadd?qid={{query_b.id}}&q2id={{query_f.id}}&db={{query_b.database}}"><button>Add missing information</button></a>
                                  <a href="../../../../sbs_allocateDocsToUser/{{query_b.id}}/{{query_f.id}}">Allocate references and citations to several users</a>
                                {% endif %}
                              {% endif %}
                            {% else %}
                                <p><a href="../../../../sbs_allocateDocsToUser/{{query_b.id}}/{{query_f.id}}">View the references and citations</a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <script>
            function docadd(qid) {

              /*
                $.ajax({
                  url: '/scoping/dodocadd',
                  data: {
                    'qid': qid
                  },
                  response: function() {
                    console.log("add docs")
                    $("#doc_adder1").html('<p><a href="../docs/'+qid+'">View the documents</a>')
                  }
                })
              */
            }

            function docrefadd(qid) {

              /*
                $.ajax({
                  url: '/scoping/dodocrefadd',
                  data: {
                    'qid': qid
                  },
                  response: function() {
                    console.log("add docs and refs")
                    $("#doc_adder2").html('<p><a href="../docs/'+qid+'">View the references</a>')
                  }
                })
              */
            }
        </script>
    </body>
</html>
