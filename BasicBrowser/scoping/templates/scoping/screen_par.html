{% extends "scoping/base_bs.html" %}
{% load bootstrap4 %}
{% load static %}

{% block content %}


<br>
<h1> Scoping Review Helper</h1>
<br>
<h2> Query Sampler (<a href="{% url 'scoping:query' tag.query.id %}">Query no. {{tag.query.id}}</a>) - Welcome, {{user.username}}, your progress: </h2>

<div class="progress m-5">
  <div class="progress-bar" role="progressbar" style="width: {{pc}}%;" aria-valuenow="{{pc}}" aria-valuemin="0" aria-valuemax="100">{{pc}}%</div>
</div>

<!-- Document info -->
<div class="row">
    <div class="panel-group container doc-con bg-white my-3 p-2 border rounded col-md-10 ">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a data-toggle="collapse" href="#collapse1">
                <h4 class="panel-title"> {{ title | safe }}, {{ do.docpar.doc.wosarticle.so }}
                    {% if do.docpar.doc.wosarticle.py %}
                        ({{ do.docpar.doc.wosarticle.py }})</h4>
                    {% endif %}
                </a>
            </div>
            <div id="collapse1" class="panel-collapse collapse">
                <p><a target="_blank" href="http://dx.doi.org/{{ doc.wosarticle.di }}">{{ doc.wosarticle.di}}</a>
                <p style="text-align:left">
                {{ doc.docauthinst }}
                {% for au in authors %}
                <span>{% if au.AF %}
                    {{au.AF}}
                    {% else %}
                    {{au.AU}}
                    {% endif %}
                    [{{au.institution|safe}}];</span>
                {% endfor %}
                <p style="text-align:left">
                    Author keywords: {{de | safe}}
                <p style="text-align:left">
                    WoS Keywords Plus: {{kwp | safe}}
                <p style="text-align:left">
                  Document ID: <a href="{% url 'scoping:document' tag.query.project.id do.docpar.doc.id %}">{{do.docpar.doc.pk}}</a>
                {% if do.docpar.doc.docfile %}
                    <p style="text-align;left">
                        PDF: <a href="{% url 'scoping:download_pdf' do.docpar.doc.docfile.id %}">View</a>
                    </p>
                {% endif %}
                <p style="text-align:left">
                {{ abstract | safe }}
            </div>
        </div>
    </div>
</div>

<div class="row">
<div class="container col-md-3">

    <!-- Form to add a note -->
    <div class="border rounded bg-white my-3 p-2">
        Add a note to this paragraph
        <hr>
        <form action="{% url 'scoping:add_note' %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.path }}">
          <input type="hidden" name="docn" value="{{do.docpar.id}}"></input>
          <input type="hidden" name="tag" value="{{tag.id}}"></input>
        <textarea class="form-control" name="note" rows=3>
        </textarea>
        <br>
        <p>
        <button type="submit" class="btn btn-primary">Add note</button>
    </form>
    </div>

    <!-- Show all the notes -->
    {% for note in notes %}
    <div class="border rounded bg-white my-3 p-2 note">
    <p class="notedesc"><b>{{note.date}}, {{note.user.username}} wrote...</b>
    <hr>
    {{note.text}}
    <hr>
    <a href="{% url 'scoping:delete' thing='Note' thingid=note.pk %}">Delete
    </a>

    </div>
    {% endfor %}

</div>
<div class="container text-con bg-white my-3 p-2 border rounded col-md-6 ">
    {% for d in pars %}
        {% if d.1 == do.docpar.id %}
            <p class="text-selected" id={{d.1}}>{{ d.0 | safe}}</p>
        {% else %}
            <p class="text-muted" id={{d.1}}>{{ d.0 | safe }}</p>
        {% endif %}
    {% endfor %}
</div>



<!-- Column 3, relevance, categories and next-->
<div class="container col-md-3">
    <form action="{% url 'scoping:rate_par' tag.id ctype do.id todo done %}" method="POST">
    {% csrf_token %}
    <div class="border rounded bg-white my-3 p-2">
        <p class="lead">Is this document relevant to the tag: {{tag.title}}?
            <hr>
            <!-- <div class="btn-group btn-group-toggle" data-toggle="buttons"> -->
              <label class="btn btn-secondary">
                <input type="radio" name="relevant" id="option1" autocomplete="off" value=1>Yes
              </label>
              <label class="btn btn-secondary">
                <input type="radio" name="relevant" id="option2" autocomplete="off" value=2>No
              </label>
              <label class="btn btn-secondary">
                <input type="radio" name="relevant" id="option3" autocomplete="off" value=3>Maybe
              </label>
              <label class="btn btn-secondary">
                <input type="radio" name="relevant" id="option3" autocomplete="off" value=9>Parse error
              </label>
            <!-- </div> -->
    </div>
<!--         {% for l in levels %}
            <div class="border rounded bg-white my-3 p-2">
                Which level {{l.0.1.level}} categories is this paragraph relevant to?
                (hover for more info)
                        <hr>
                    {% for t in l %}
                    <button value="{{t.1.id}}" type="button" class="btn cat {{t.0}}" data-toggle="tooltip" data-placement="top" title="{{t.1.description}}">{{t.1}}</button>

                    {% endfor %}
            </div>
        {% endfor %} -->


    {% bootstrap_button 'Save/Next >>>' %}
</div>

</div>

</div>

<div class="tools_statement">
  <button id="btn_add_stat" type="button" title="Add statement" value="add"><img src="{% static 'scoping/img/icon_add.png' %}" width="20px" height="20px"/></button>
  <!-- <img src="{% static 'scoping/img/icon_add.png' %}" width="20px" height="20px"/> Add statement -->
  <!-- <li><img src="{% static 'scoping/img/icon_del.png' %}" width="20px" height="20px"/></li> -->
</div>



{% for s in stats_cats %}
  <div class="tools" id="statool{{s.0.0.0}}">
    <div class="tools_statement2">
      <button id="btn_del_stat" type="button" title="Delete statement" value="remove"><img src="{% static 'scoping/img/icon_del.png' %}" width="20px" height="20px"/></button>
      <!-- <img src="{% static 'scoping/img/icon_add.png' %}" width="20px" height="20px"/> Add statement -->
      <!-- <li><img src="{% static 'scoping/img/icon_del.png' %}" width="20px" height="20px"/></li> -->
    </div>
    {% for l in s %}
    <div class="tagtools">
        {{l.0.2.group}}
        {% for t in l %}
            <button value="{{t.2.id}}" type="button" class="btntag cat {{t.1}}" data-toggle="tooltip" data-placement="top" title="{{t.2.description}}">{{t.2}}</button>
        {% endfor %}
    </div>
    {% endfor %}
</div>
{% endfor %}

{% endblock %}

{% block script %}
<script>

if (!window.x) {
    x = {};
}

function escapeRegExp(str) {
  return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
}

x.Selector = {};
x.Selector.getSelected = function() {
    var t = '';
    if (window.getSelection) {
        s = window.getSelection();
        if (s.baseNode.parentNode.className.toLowerCase() == "text-selected") {
            t = s;
        }
    } else if (document.getSelection) {
        s = document.getSelection();
        if (s.baseNode.parentNode.className.toLowerCase() == "text-selected") {
            t = s;
        }
        //t = document.getSelection();
    } else if (document.selection) {
        s = document.selection.createRange().text;
        if (s.baseNode.parentNode.className.toLowerCase() == "text-selected") {
            t = s;
        }
        //t = document.selection.createRange().text;
    }
    return t;
}

var pageX;
var pageY;
//var tools_statement;
//tools_statement=false;
$(document).ready(function() {
    $(document).bind("mouseup", function() {
        var selectedText = x.Selector.getSelected();
        if(selectedText != ''){
            // Display statement tool box
            //tools_statement = true;
            $('div.tools_statement').css({
                'left': pageX + 5,
                'top' : pageY - 55
            }).fadeIn(200);

        } else {
            //tools_statement = false;
            $('div.tools_statement').fadeOut(200);
        }
    });
    $(document).on("mousedown", function(e){
          //if (!tools_statement){
            pageX = e.pageX;
            pageY = e.pageY;
          //}
    });
});

// Process DocStatement
var statementid;
$(".statement").click(function(e) {

  pageX = e.pageX;
  pageY = e.pageY;

  console.log($(this).position)

  statementid = $(this).attr("id");
  // Tag DocStatement
  $('#statool'+statementid).css({
      'left': pageX + 5,
      'top' : pageY + 10
  }).fadeIn(200);
  // Delete DocStatement
  // $('div.tools_statement2').css({
  //     'left': pageX + 5,
  //     'top' : pageY - 10
  // }).fadeIn(200);
})

$("#btn_del_stat").click(function() {
  var data = {
        "idstat" : statementid,
        "idpar" : "{{do.docpar.pk}}",
        "tid"   : "{{tag.pk}}"
      }

  console.log(data)

  $.ajax({
      url: "{% url 'scoping:del_statement' %}",
      data: data,
      success: function(data) {
          $("p#{{do.docpar.pk}}").replaceWith(data);
      },
      dataType: 'html'
  })

  $('div.tools_statement2').fadeOut(200);
})

// Add new DocStatement
$("#btn_add_stat").click(function() {
  var s = window.getSelection();
  var text_paragraph = s.baseNode.parentNode.innerText;
  var text_selection = s.toString();
  //console.log(text_paragraph);
  //console.log(text_selection);
  var match_text_par = text_paragraph.match(escapeRegExp(text_selection));
  //console.log(match_text_par)
  var startSelection = match_text_par.index; // Get start of selection in paragraph
  //console.log(startSelection)
  var endSelection   = startSelection + text_selection.length;
  //console.log(endSelection)

  var data = {
        "idpar" : "{{do.docpar.pk}}",
        "text"  : text_selection,
        "par"   : text_paragraph,
        "start" : startSelection,
        "end"   : endSelection,
        "tid"   : "{{tag.pk}}"
      }

  console.log(data)

  $.ajax({
      url: "{% url 'scoping:add_statement' %}",
      data: data,
      success: function(data) {
          $("p#{{do.docpar.pk}}").replaceWith(data);
      },
      dataType: 'html'
  })
})


$("#main").css("width", "100%");
$("#main").removeClass("col-md-10");
$("#main").removeClass("container");
$("#main").addClass("p-4");

$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
//go to paragraph
var elmnt = document.getElementById({{do.docpar.id}});
elmnt.scrollIntoView({behavior:"smooth",block:"center"});

//
$(".cat").click(function(){
    id2 = $(this).val();

    console.log($(this));

    idstat = $(this)[0].parentNode.parentNode.getAttribute("id");
    idstat=idstat.substring("statool".length,s.length);
    console.log(id2)
    console.log(idstat)

    if ($(this).hasClass("True")) {
        method = "remove"
    } else {
        method = "add"
    }

    $(this).toggleClass("True")

    //
    $.ajax({
        url: "{% url 'scoping:update_thing' %}",
        data: {
          "thing1": "DocStatement",
          "id1": idstat,
          'thing2': 'Technology',
          'id2': id2,
          "method": method
        },
        success: function(data) {

        }
    })
})

</script>
{% endblock %}
