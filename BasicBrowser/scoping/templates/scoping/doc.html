{% extends "scoping/base.html" %}
{% block content %}

<h1> Scoping Review Helper</h1>
<br>
<h2> Query Sampler (<a href="/scoping/query/{{query.id}}">Query no. {{query.id}}</a>) - Welcome, {{user.username}}, your progress: </h2>
<div id="progress"></div>
<!-- Query manager -->
<p><a href="/scoping/screen/{{query.id}}/{{tag.id}}/5/-1">Back</a>

<p>Is the document below (one of {{ ndocs }} remaining) relevant?

<div id="criteria">
<h4>Inclusion/Exclusion Criteria</h4>
<p>
{{ query.criteria | safe}}
</div>

</div>

<table width="100%">
<td width="20%">

{% for note in notes %}
<div class="note">
<p class="notedesc"><b>{{note.date}}, {{note.user.username}} wrote...</b>
<hr>
{{note.text}}
<hr>
<a href="{% url 'scoping:delete' thing='Note' thingid=note.pk %}">Delete
</a>

</div>
{% endfor %}
<td width="60%">
    <div id="docbox">
    <h4> {{ title | safe }}</h4>
    <p>{{ doc.wosarticle.so }} ({{ doc.wosarticle.py }}) <a target="_blank" href="http://dx.doi.org/{{ doc.wosarticle.di }}">{{ doc.wosarticle.di}}</a>
    <p style="text-align:left">
    {{ doc.docauthinst }}
    {% for au in authors %}
	    <span>{{au.AF}} [{{au.institution}}];</span>
    {% endfor %}
    <p style="text-align:left">
        Author keywords: {{de | safe}}
    <p style="text-align:left">
        WoS Keywords Plus: {{kwp | safe}}
    <p style="text-align:left">
      Document ID: <a href="{% url 'scoping:document' query.project.id doc.id %}">{{doc.pk}}</a>
    <p style="text-align:left">
    {{ abstract | safe }}
    </div>
    <table class="spread" width="100%">
	    <tr>
        {% if innovation %}
        <tr>
      <td><button onclick="review(5)">Yes Technology & Yes Innovation</button>
	    <td><button onclick="review(6)">Yes Technology & No Innovation</button>
	    <td><button onclick="review(7)">No Technology & Yes Innovation</button>
	    <td><button onclick="review(8)">No Technology & No Innovation</button>
        {% else %}
        <td><button onclick="review(1)">Yes</button>
  	    <td><button onclick="review(2)">No</button>
  	    <td><button onclick="review(3)">Maybe?</button>
        {% endif %}
	    </tr>
    </table>
{% if innovation %}

{% include 'scoping/doctag_box.html' with t=tags.Innovation %}

{% else %}

{% include 'scoping/doctag_box.html' with t=tags.Technology %}

{% endif %}

<td width="20%">
<div class="noteform">
    <form action="{% url 'scoping:add_note' %}" method="post">
      {% csrf_token %}
      <input type="hidden" name="docn" value="{{doc.id}}"></input>
      <input type="hidden" name="qid" value="{{query.id}}"></input>
      <input type="hidden" name="ctype" value="{{ctype}}"></input>
      <input type="hidden" name="tag" value="{{tag.id}}"></input>
      <input type="hidden" name="d" value="{{d}}"></input>
    <textarea name="note" rows=3 cols=25>
    </textarea>
    <p>
    <input type="submit" value="Add note" />
</form>
</div>


</table>
<p>

{% endblock %}

{% block script %}

<script>



$(".thing_name").click(function() {
    thing2 = $(this).attr("data-thing")
    id2 = $(this).attr("data-value")

    $.ajax({
        url: "{% url 'scoping:update_thing' %}",
        data: {
          "thing1": "Doc",
          "id1": "{{doc.pk}}",
          'thing2': thing2,
          'id2': id2,
          "method": "add"
        },
        success: function(data) {
            location.reload()
        }
    })
})


var tdocs = {{ tdocs }}
var sdocs = {{ sdocs }}

console.log(tdocs)
console.log(sdocs)

var width = $("#progress").parent().width()*0.8;
var height = 40

var graph = d3.select("#progress")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

graph.append("rect")
    .attr("width", width)
    .attr("height", height)
    .style("fill", "white")
    .style("stroke", "black")
    .style("stroke-width", 2)

xscale = d3.scale.linear()
    .domain([0, tdocs])
    .range([width*0.0, width*1]);

graph.append("rect")
    .attr("width", xscale(sdocs))
    .attr("y", height*0.35)
    .attr("height", height*0.3)
    .style("fill", "steelblue")
    .style("stroke", "grey")
    .style("stroke-width", 1);

tick = tdocs/10
ticks = []
for (i=1;i<10;i++) {
    ticks.push({'pcnt': i*10, 'value': i*tick})
}
console.log(ticks)

graph.selectAll("line")
	.data(ticks)
	.enter()
	.append("line")
    .style("stroke","grey")
    .style("stroke-width",1)
	.attr("x1", function(d) { return xscale(d.value)})
	.attr("x2", function(d) { return xscale(d.value)})
    .attr("y1", 0)
    .attr("y2", height);


var qid = {{ query.id }}
var docid = "{{ doc.pk }}"


function review(d) {
	console.log(qid)
	console.log(docid)
    console.log({{back}})
	$.ajax({
		url: '/scoping/do_review',
		data: {
            'tid' : {{tag.id}},
			'query': qid,
			'doc': docid,
			'd':d
		},
		success: function() {
            if ({{ctype}}>1) {
                var doc = {{d}}
                url = '/scoping/screen/{{query.id}}/{{tag.id}}/{{ctype}}/'+(doc+1)
                window.location.href = url
            } else if ({{back}} == -1)   {
                console.log({{d}})
                var doc = {{d}}
                url = '/scoping/user'
                window.location.href = url
            } else {
			    location.reload()
            }

		}
	})
console.log({{page}})
}

$(document).keydown(function(e){
    if (e.keyCode == 49) {
        review(1)
    }
    if (e.keyCode == 50) {
        review(2)
    }
    if (e.keyCode == 51) {
        review(3)
    }
    if (e.keyCode == 52) {
        review(4)
    }
});
</script>

{% endblock %}
